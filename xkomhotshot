#!/usr/bin/env python3
import asyncio
import os
from html import escape

import cloudscraper
from telegram import Bot

token = os.environ.get("TG_TOKEN")
channel = os.environ.get("TG_CHANNEL")

API_HEADERS = {
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0",
    "X-API-Key": "jfsTOgOL23CN2G8Y",
}
API_URL = "https://mobileapi.x-kom.pl/api/v1/xkom/hotShots/current?onlyHeader=true"


def get_hot_shot():
    requests = cloudscraper.create_scraper()
    response = requests.get(url=API_URL, headers=API_HEADERS).json()
    hot_shot_info = {
        "id": response["Id"],
        "name": response["PromotionName"],
        "photo_url": response["PromotionPhoto"]["Url"],
        "price_min_date": response["MinPriceInfo"]["DateMinPrice"][:10],
        "price_min": response["MinPriceInfo"]["MinPrice"],
        "price_promo": response["Price"],
        "price_regular": response["OldPrice"],
        "item_count": response["PromotionTotalCount"],
    }
    return hot_shot_info


def build_html_caption(data: dict) -> str:
    name = escape(data["name"])
    price_promo = data["price_promo"]
    price_regular = data["price_regular"]
    if price_regular:
        discount = (price_regular - price_promo) / price_regular
    else:
        discount = 0
    price_min = data["price_min"]
    price_min_date = escape(data["price_min_date"])
    promotion_id = escape(str(data["id"]))
    link = f"https://www.x-kom.pl/goracy_strzal/{promotion_id}"
    return (
        f"<b>{name}</b>\n"
        f"Cena promocyjna: <b>{price_promo} PLN (-{discount:.0%})</b>\n"
        f"Cena regularna: <b>{price_regular} PLN</b>\n"
        f"Cena najniższa z ostatnich 30 dni: <b>{price_min} PLN ({price_min_date})</b>\n"
        f"Ilość sztuk: <b>{data['item_count']}</b>\n"
        f"Link: {link}"
    )


async def main():
    bot = Bot(token)
    hot_shot_data = get_hot_shot()
    caption = build_html_caption(hot_shot_data)
    try:
        await bot.send_photo(
            chat_id=channel,
            photo=hot_shot_data["photo_url"],
            caption=caption,
            parse_mode="HTML",
        )
    except Exception:
        await bot.send_message(chat_id=channel, text=caption, parse_mode="HTML")


if __name__ == "__main__":
    asyncio.run(main())
